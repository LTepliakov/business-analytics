drop view if exists analytics.lm_v_erp_charging_export

;

create view analytics.lm_v_erp_charging_export as




Select 
            date_trunc('month',hour_nk)::DATE as Date, 
            -- account_id as Charging_ID,
            -- Master_Account_ID as ERP_ID,
            Master_Customer_ID,
            split_part(bundle_name,'_',2) as Bundle_Name,
            current_selling_rate_value as Selling_Rate,
            current_selling_rate_currency as Currency_ISO,
            exchange_rate as FX_Rate,
            -- tariff,
            -- country,
            -- event_type,
            -- result,
			-- action,
			line_item_id,
			-- case when general_ledger_code='Forfeiture Of Package Balance' then 1 else 0 end  as Forfeiture_Flag, 
				
			/*
			case 
                when split_part(bundle_name,'_',2) ='mb' then 'Balance'
                when bundle_name is null then 'Zero_Rated'
                else 'Package'
                end
            as Transaction_Type,
           	*/
			
			
            sum(
            case 
            when split_part(bundle_name,'_',2) ='mb' then units
            when bundle_name is null then units
            else charge
            end)
            as Chargeable_Units,
            
            
            sum(
            case 
            when split_part(bundle_name,'_',2) ='mb' then charge
            when bundle_name is null then 0
            else charge*current_selling_rate_value
            end)
            as USD_Revenue
            
          

from aggregate.fact_sms_consumption_aggregate
join analytics.lm_v_master_account_mapping  on aggregate.fact_sms_consumption_aggregate.account_id = analytics.lm_v_master_account_mapping.Charging_ID_L0 

where date(hour_nk)>=date_trunc('month', CURRENT_date - interval '1 month' )
and date(hour_nk)<date_trunc('month', CURRENT_date  )

and result='SUCCESS'

and ((event_type='default.sms' and action='DIRECT_DEBIT')       OR      ( action='CHARGE'  and  general_ledger_code='Forfeiture Of Package Balance'))

-- and action in ('DIRECT_DEBIT','CHARGE','REFUND')

group by 1,2,3,4,5,6,7


